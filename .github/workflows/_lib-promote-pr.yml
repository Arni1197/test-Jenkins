name: _lib | Promote via PR (GitOps)

on:
  workflow_call:
    inputs:
      service_name:
        required: true
        type: string

      target_env:
        description: "dev / staging / prod"
        required: true
        type: string

      source_values_file:
        description: "Path to source env values file (optional, if new_tag not set)"
        required: false
        type: string
        default: ""

      target_values_file:
        description: "Path to target env values file"
        required: true
        type: string

      new_tag:
        description: "If set, use this tag instead of reading from source_values_file"
        required: false
        type: string
        default: ""

      new_digest:
        description: "If set, also update digest in target_values_file"
        required: false
        type: string
        default: ""

      base_branch:
        required: false
        type: string
        default: "main"

      pr_branch_prefix:
        required: false
        type: string
        default: "promote"

      pr_labels:
        description: "Comma separated labels"
        required: false
        type: string
        default: "promotion,gitops"

      skip_if_exists:
        description: "If true, do nothing when a promote PR already exists"
        required: false
        type: boolean
        default: true

jobs:
  promote:
    name: "${{ inputs.service_name }} | Promote to ${{ inputs.target_env }}"
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.base_branch }}

      - name: Debug inputs + files
        shell: bash
        run: |
          set -euo pipefail
          echo "base_branch=${{ inputs.base_branch }}"
          echo "service_name=${{ inputs.service_name }}"
          echo "target_env=${{ inputs.target_env }}"
          echo "source_values_file='${{ inputs.source_values_file }}'"
          echo "target_values_file='${{ inputs.target_values_file }}'"
          echo "new_tag='${{ inputs.new_tag }}'"
          echo "new_digest='${{ inputs.new_digest }}'"
          echo "GITHUB_REF=$GITHUB_REF"
          echo "GITHUB_SHA=$GITHUB_SHA"
          echo "---- repo root ----"
          ls -la
          echo "---- k8s/environments ----"
          ls -la k8s/environments || true
          echo "---- staging values services ----"
          ls -la k8s/environments/staging/values/services || true
          echo "---- local values services ----"
          ls -la k8s/environments/local/values/services || true

      - name: Configure git
        shell: bash
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Resolve tag+digest (source -> target)
        id: resolved
        shell: bash
        run: |
          set -euo pipefail

          SRC_FILE="${{ inputs.source_values_file }}"
          TGT_FILE="${{ inputs.target_values_file }}"

          if [ ! -f "$TGT_FILE" ]; then
            echo "❌ Target values file not found: $TGT_FILE"
            exit 1
          fi

          read_yaml_field () {
            local file="$1"
            local key="$2"
            grep -E "^[[:space:]]*$key:[[:space:]]*" "$file" \
              | head -n1 \
              | sed -E "s/^[[:space:]]*$key:[[:space:]]*//" \
              | tr -d '"'
          }

          # current target
          TGT_TAG="$(read_yaml_field "$TGT_FILE" "tag")"
          TGT_DIGEST="$(read_yaml_field "$TGT_FILE" "digest" || true)"

          if [ -z "${TGT_TAG:-}" ]; then
            echo "❌ Cannot find 'tag:' in target file: $TGT_FILE"
            exit 1
          fi

          # new tag
          if [ -n "${{ inputs.new_tag }}" ]; then
            NEW_TAG="${{ inputs.new_tag }}"
          else
            if [ -z "$SRC_FILE" ] || [ ! -f "$SRC_FILE" ]; then
              echo "❌ Either new_tag or valid source_values_file must be provided."
              exit 1
            fi
            NEW_TAG="$(read_yaml_field "$SRC_FILE" "tag")"
            if [ -z "${NEW_TAG:-}" ]; then
              echo "❌ Cannot find 'tag:' in source file: $SRC_FILE"
              exit 1
            fi
          fi

          # new digest
          if [ -n "${{ inputs.new_digest }}" ]; then
            NEW_DIGEST="$(echo "${{ inputs.new_digest }}" | tr -d '"')"
          else
            if [ -n "$SRC_FILE" ] && [ -f "$SRC_FILE" ]; then
              NEW_DIGEST="$(read_yaml_field "$SRC_FILE" "digest" || true)"
            else
              NEW_DIGEST=""
            fi
          fi

          echo "✅ Target current tag:    $TGT_TAG"
          echo "✅ Target current digest: ${TGT_DIGEST:-<empty>}"
          echo "✅ New desired tag:       $NEW_TAG"
          echo "✅ New desired digest:    ${NEW_DIGEST:-<empty>}"

          echo "tgt_tag=$TGT_TAG" >> "$GITHUB_OUTPUT"
          echo "tgt_digest=${TGT_DIGEST:-}" >> "$GITHUB_OUTPUT"
          echo "new_tag=$NEW_TAG" >> "$GITHUB_OUTPUT"
          echo "new_digest=${NEW_DIGEST:-}" >> "$GITHUB_OUTPUT"

      - name: Stop (already up to date)
        if: ${{ steps.resolved.outputs.tgt_tag == steps.resolved.outputs.new_tag && steps.resolved.outputs.tgt_digest == steps.resolved.outputs.new_digest }}
        shell: bash
        run: |
          echo "✅ Target is already up-to-date (tag+digest). Nothing to do."
          exit 0

      - name: Determine branch name
        id: bn
        shell: bash
        run: |
          set -euo pipefail
          BR="${{ inputs.pr_branch_prefix }}/${{ inputs.service_name }}/${{ inputs.target_env }}/${{ steps.resolved.outputs.new_tag }}-${{ github.run_id }}"
          BR="$(echo "$BR" | tr ' ' '-' | tr ':' '-')"
          echo "branch=$BR" >> "$GITHUB_OUTPUT"
          echo "✅ Promote branch: $BR"

      - name: Check existing open PR
        if: ${{ inputs.skip_if_exists }}
        id: prcheck
        uses: actions/github-script@v7
        env:
          BRANCH_NAME: "${{ steps.bn.outputs.branch }}"
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const head = `${owner}:${process.env.BRANCH_NAME}`;

            const prs = await github.rest.pulls.list({
              owner,
              repo,
              state: "open",
              head,
            });

            core.setOutput("exists", prs.data.length > 0 ? "true" : "false");
            console.log(`Open PRs for ${head}:`, prs.data.length);

      - name: Stop (PR already exists)
        if: ${{ inputs.skip_if_exists && steps.prcheck.outputs.exists == 'true' }}
        shell: bash
        run: |
          echo "✅ Promotion PR already exists for branch: ${{ steps.bn.outputs.branch }}"
          exit 0

      - name: Create branch
        shell: bash
        run: |
          set -euo pipefail
          git checkout -b "${{ steps.bn.outputs.branch }}"

      - name: Update target values file (image.tag + image.digest)
        shell: bash
        run: |
          set -euo pipefail
          FILE="${{ inputs.target_values_file }}"

          if [ ! -f "$FILE" ]; then
            echo "❌ Target values file not found: $FILE"
            exit 1
          fi

          echo "Updating $FILE"
          echo "  -> tag:    ${{ steps.resolved.outputs.new_tag }}"
          echo "  -> digest: ${{ steps.resolved.outputs.new_digest }}"

          # Update tag
          sed -i.bak -E "s/^([[:space:]]*tag:[[:space:]]*).*/\\1${{ steps.resolved.outputs.new_tag }}/" "$FILE"

          # Update digest (if present in new_digest)
          if [ -n "${{ steps.resolved.outputs.new_digest }}" ]; then
            if grep -qE "^[[:space:]]*digest:[[:space:]]*" "$FILE"; then
              sed -i.bak -E "s/^([[:space:]]*digest:[[:space:]]*).*/\\1\"${{ steps.resolved.outputs.new_digest }}\"/" "$FILE"
            else
              awk -v dg="${{ steps.resolved.outputs.new_digest }}" '
                {print}
                $0 ~ /^[[:space:]]*tag:[[:space:]]*/ && !done {
                  print "  digest: \"" dg "\""
                  done=1
                }
              ' "$FILE" > "$FILE.tmp" && mv "$FILE.tmp" "$FILE"
            fi
          fi

          rm -f "$FILE.bak"

          echo "Result:"
          grep -nE "^[[:space:]]*(tag|digest):" "$FILE" || true

      - name: Commit changes
        shell: bash
        run: |
          set -euo pipefail
          git add "${{ inputs.target_values_file }}"
          git commit -m "promote(${{ inputs.service_name }}): ${{ inputs.target_env }} -> ${{ steps.resolved.outputs.new_tag }}" || exit 0

      - name: Push branch
        shell: bash
        run: |
          set -euo pipefail
          git push -u origin "${{ steps.bn.outputs.branch }}"

      - name: Create PR
        uses: actions/github-script@v7
        env:
          SERVICE_NAME: "${{ inputs.service_name }}"
          TARGET_ENV: "${{ inputs.target_env }}"
          NEW_TAG: "${{ steps.resolved.outputs.new_tag }}"
          NEW_DIGEST: "${{ steps.resolved.outputs.new_digest }}"
          TARGET_FILE: "${{ inputs.target_values_file }}"
          SOURCE_FILE: "${{ inputs.source_values_file }}"
          HEAD_BRANCH: "${{ steps.bn.outputs.branch }}"
          BASE_BRANCH: "${{ inputs.base_branch }}"
          PR_LABELS: "${{ inputs.pr_labels }}"
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            const title = `Promote ${process.env.SERVICE_NAME} to ${process.env.TARGET_ENV}: ${process.env.NEW_TAG}`;

            const bodyLines = [
              `This is an automated GitOps promotion PR.`,
              ``,
              `- Service: **${process.env.SERVICE_NAME}**`,
              `- Target env: **${process.env.TARGET_ENV}**`,
              `- New image tag: **${process.env.NEW_TAG}**`,
              `- New image digest: **${process.env.NEW_DIGEST || "<empty>"}**`,
              `- Target values: \`${process.env.TARGET_FILE}\``,
            ];

            if (process.env.SOURCE_FILE && process.env.SOURCE_FILE.trim() !== "") {
              bodyLines.push(`- Source values: \`${process.env.SOURCE_FILE}\``);
            }

            const body = bodyLines.join("\n");

            const pr = await github.rest.pulls.create({
              owner,
              repo,
              title,
              head: process.env.HEAD_BRANCH,
              base: process.env.BASE_BRANCH,
              body,
            });

            const labels = (process.env.PR_LABELS || "")
              .split(",")
              .map(s => s.trim())
              .filter(Boolean);

            if (labels.length) {
              await github.rest.issues.addLabels({
                owner,
                repo,
                issue_number: pr.data.number,
                labels,
              });
            }

            console.log(`✅ PR created: #${pr.data.number} ${pr.data.html_url}`);