name: catalog-service | main build & dev deploy (via PR)

on:
  push:
    branches: ["main"]
    paths:
      - "catalog-service/**"
      - ".github/workflows/main/catalog-service.main.yml"

permissions:
  contents: write
  packages: write
  pull-requests: write

concurrency:
  group: main-catalog-service-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build_push:
    name: catalog-service | Docker build & push
    uses: ./.github/workflows/_lib-docker-build-push.yml
    permissions:
      contents: read
      packages: write
    with:
      service_name: "catalog-service"
      context: "catalog-service"
      dockerfile: "catalog-service/Dockerfile"
      image: "ghcr.io/arni1197/catalog-service"
      tag: "sha-${{ github.sha }}"
      push: true
      platforms: linux/amd64,linux/arm64

  update_dev_values_pr:
    name: catalog-service | PR update dev values
    needs: [build_push]
    uses: ./.github/workflows/_lib-promote-pr.yml
    permissions:
      contents: write
      pull-requests: write
    with:
      service_name: "catalog-service"
      target_env: "dev"
      target_values_file: "k8s/environments/local/values/services/catalog-service.yaml"
      new_tag: "sha-${{ github.sha }}"
      new_digest: "${{ needs.build_push.outputs.digest }}"
      base_branch: "main"
      pr_branch_prefix: "promote/dev"
      pr_labels: "gitops,dev"
      skip_if_exists: true