name: api-gateway | release (trivy -> retag & sign)

on:
  push:
    tags:
      - "api-gateway-v*.*.*"

permissions:
  contents: read
  packages: write
  id-token: write

concurrency:
  group: release-api-gateway-${{ github.ref }}
  cancel-in-progress: true

jobs:
  trivy_gate:
    name: api-gateway | Trivy gate (sha tag)
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read

    steps:
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Wait until sha image exists in registry
        # если релиз-тег поставили раньше, чем sha-образ успел появиться
        run: |
          set -e
          IMG="ghcr.io/${{ github.repository_owner }}/api-gateway:sha-${{ github.sha }}"
          echo "Checking image exists: $IMG"
          for i in $(seq 1 30); do
            if docker manifest inspect "$IMG" >/dev/null 2>&1; then
              echo "✅ Found: $IMG"
              exit 0
            fi
            echo "⏳ Not found yet, retry $i/30..."
            sleep 5
          done
          echo "❌ Image not found after retries: $IMG"
          exit 1

      - name: Trivy scan (fail on HIGH/CRITICAL)
        uses: aquasecurity/trivy-action@0.24.0
        with:
          image-ref: ghcr.io/${{ github.repository_owner }}/api-gateway:sha-${{ github.sha }}
          format: table
          exit-code: 1
          severity: CRITICAL,HIGH
          ignore-unfixed: true

  retag_sign:
    name: api-gateway | Retag & sign (release)
    needs: [trivy_gate]
    uses: ./.github/workflows/_lib-release-retag-sign.yml
    with:
      service_name: "api-gateway"
      image: "ghcr.io/${{ github.repository_owner }}/api-gateway"
      source_tag: "sha-${{ github.sha }}"
      release_tag: "${{ github.ref_name }}"
      registry: "ghcr.io"
      sign: true