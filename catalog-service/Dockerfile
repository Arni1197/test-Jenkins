# üèó Build stage: deps + prisma generate + build
FROM node:20-alpine AS build
WORKDIR /app

COPY package*.json ./
COPY prisma ./prisma
RUN npm ci

# Prisma Client –≥–µ–Ω–µ—Ä–∏–º —Ç—É—Ç (–≥–¥–µ –µ—Å—Ç—å dev deps)
RUN npx prisma generate

COPY tsconfig*.json ./
COPY src ./src
RUN npm run build


# üöÄ Runtime: –±–µ—Ä—ë–º build –∏ –≤—ã–∫–∏–¥—ã–≤–∞–µ–º dev deps
FROM node:20-alpine AS runtime
WORKDIR /app
ENV NODE_ENV=production

# –±–µ—Ä—ë–º –≤—Å—ë, —á—Ç–æ –Ω—É–∂–Ω–æ, –∏–∑ build
COPY --from=build /app/node_modules ./node_modules
COPY --from=build /app/prisma ./prisma
COPY --from=build /app/dist ./dist
COPY package*.json ./

# —É–¥–∞–ª—è–µ–º dev deps (–ø–æ–ª—É—á–∞–µ–º prod node_modules)
RUN npm prune --omit=dev \
  && mkdir -p /app/logs \
  && chown -R node:node /app

USER node
EXPOSE 3003
CMD ["node", "dist/src/main.js"]